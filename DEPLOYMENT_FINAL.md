# Final Deployment Guide - MBPP Workflows

## ✅ Everything is Automated

When you deploy, the following happens automatically:

### 1. **DynamoDB Tables Created**
- `mbpp-reports` - Stores all tickets
- `mbpp-events` - Tracks workflow events
- Both have TTL (90 days auto-delete)
- GSI on events table for querying by ticket

### 2. **Lambda Functions Updated**
- WebSocket handler gets MBPP Workflow layer
- Automatic permissions to access MBPP tables
- Environment variables configured

### 3. **No Weird Characters**
- All resource names are clean
- No special characters in names
- Simple naming: `mbpp-reports`, `mbpp-events`

## 🚀 Single Command Deployment

```bash
cd cdk

# Deploy everything at once
cdk deploy --all --profile test
```

This deploys:
1. ✅ Database tables (sessions, conversations, analytics, events)
2. ✅ MBPP Workflow tables (reports, events)
3. ✅ Lambda functions with workflow integration
4. ✅ API Gateway (WebSocket + HTTP)
5. ✅ All permissions automatically configured

## 📋 What Happens Automatically

### WebSocket Handler
- ✅ Gets MBPP Workflow layer
- ✅ Can access `mbpp-reports` table
- ✅ Can access `mbpp-events` table
- ✅ Routes workflow messages automatically
- ✅ Falls back to Nova Pro for RAG

### Frontend (No Changes Needed)
- ✅ Uses same WebSocket endpoint
- ✅ Receives workflow responses
- ✅ Displays as normal messages
- ✅ No code changes required

## 🎯 User Flow (Automated)

```
User: "MBPP website is down"
  ↓ (WebSocket sends to Lambda)
  ↓ (Lambda detects workflow trigger)
  ↓ (MBPP Agent starts complaint workflow)
  ↓ (Response sent back via WebSocket)
  ↓ (Frontend displays: "Would you like to report an incident?")
  ↓ (User continues conversation)
  ↓ (Ticket saved to DynamoDB automatically)
  ↓ (Event logged automatically)
```

## 📊 Verify Deployment

```bash
# Check if tables exist
aws dynamodb list-tables --profile test | grep mbpp

# Check Lambda has correct environment
aws lambda get-function-configuration \
  --function-name ChatbotLambdaStack-WebSocketHandler \
  --profile test \
  --query 'Environment.Variables'

# Test WebSocket
wscat -c wss://ynw017q5lc.execute-api.ap-southeast-1.amazonaws.com/prod
```

## ✅ Clean Resource Names

All resources have clean names:
- `mbpp-reports` (not `mbpp-reports-a1b2c3`)
- `mbpp-events` (not `mbpp-events-x9y8z7`)
- `chatbot-api-keys` (not `chatbot/api-keys-weird#chars`)

## 🔧 Environment Variables (Auto-Set)

```bash
REPORTS_TABLE=mbpp-reports
EVENTS_TABLE=mbpp-events
BEDROCK_REGION=ap-southeast-1
SESSIONS_TABLE=<auto-generated>
CONVERSATIONS_TABLE=<auto-generated>
```

## 📝 Post-Deployment

Nothing required! The system is ready to use immediately:

1. ✅ Frontend works without changes
2. ✅ Workflows trigger automatically
3. ✅ Reports saved to DynamoDB
4. ✅ Events tracked automatically

## 🎉 Summary

**One command deploys everything:**
```bash
cdk deploy --all --profile test
```

**Zero manual configuration needed:**
- ✅ Tables created automatically
- ✅ Permissions set automatically
- ✅ Integration works automatically
- ✅ Frontend works without changes

**Clean resource names:**
- ✅ No weird characters
- ✅ Simple, readable names
- ✅ Easy to find in AWS Console

---

**Ready to deploy!** Just run `cdk deploy --all --profile test`
